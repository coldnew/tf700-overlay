all: adbd

CC = arm-unknown-linux-gnueabi-gcc

SRC_DIR := ../aosp/platform/system/core/adb
LOCAL_SRC_FILES := \
	adb.c \
	backup_service.c \
	fdevent.c \
	transport.c \
	transport_local.c \
	transport_usb.c \
	sockets.c \
	services.c \
	file_sync_service.c \
	jdwp_service.c \
	framebuffer_service.c \
	remount_service.c \
	usb_linux_client.c \
	log_service.c \
	utils.c

LOCAL_CFLAGS := -O2 -g -DADB_HOST=0 -Wall -Wno-unused-parameter
LOCAL_CFLAGS += -D_XOPEN_SOURCE -D_GNU_SOURCE
LOCAL_CFLAGS += -DALLOW_ADBD_ROOT=1

CUTILS_SRC_FILES := socket_inaddr_any_server.c \
                    socket_local_client.c \
                    socket_local_server.c \
                    socket_loopback_client.c \
                    socket_loopback_server.c
CUSTOM_SRC_FILES := properties.c reboot.c
LOCAL_CFLAGS += -I"$(SRC_DIR)" \
                -I../aosp/platform/system/core/include \
                -I../aosp/platform/hardware/libhardware/include


adbd: $(patsubst %.c,%.o,$(LOCAL_SRC_FILES) $(CUTILS_SRC_FILES) $(CUSTOM_SRC_FILES))
	$(CC) -g $(LDFLAGS) -static -o "$@" $^ -lpthread

clean:
	rm -f *.o services.c

spotless: clean
	rm -f adbd


$(filter-out services.o,$(LOCAL_SRC_FILES:%.c=%.o)) : %.o: $(SRC_DIR)/%.c
	$(CC) $(LOCAL_CFLAGS) $(CFLAGS) -o "$@" -c "$<"

services.o: services.c
	$(CC) $(LOCAL_CFLAGS) $(CFLAGS) -o "$@" -c "$<"

services.c: $(SRC_DIR)/services.c
	sed 's:/system/bin/sh:/bin/sh:' <"$<" >"$@"

$(CUTILS_SRC_FILES:%.c=%.o) : %.o: $(dir $(SRC_DIR))libcutils/%.c
	$(CC) $(LOCAL_CFLAGS) $(CFLAGS) -o "$@" -c "$<"

$(CUSTOM_SRC_FILES:%.c=%.o) : %.o: %.c
	$(CC) $(LOCAL_CFLAGS) $(CFLAGS) -o "$@" -c "$<"
